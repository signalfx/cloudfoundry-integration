#/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Use alpine for small size
docker_image=quay.io/signalfuse/collectd-alpine

tmpdir=$(mktemp -d collectd-rootfs-XXX)
trap "rm -rf $tmpdir" EXIT

mkdir ${tmpdir}/rootfs

container_id=$(docker create $docker_image)
trap "docker rm -f $container_id" EXIT

# Force success since Mac's bsdtar returns 1 even though everything seems to
# work fine
docker export $container_id | tar -C ${tmpdir}/rootfs -xvf - || true

tar -C $tmpdir -czf $SCRIPT_DIR/tmp/collectd-rootfs.tar.gz rootfs
